<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <video id="video"></video>
  <canvas id="canvas"></canvas>
  <canvas id="canvas2"></canvas>
</body>
<script>
 function main () {
  function waterMask(ctx, w, maxW) {
// Set line width
ctx.lineWidth = 10;

// Wall
ctx.strokeRect(75, 140, 150, 110);

// Door
ctx.fillRect(130, 190, 40, 60);

// Roof
ctx.beginPath();
ctx.moveTo(50, 140);
ctx.lineTo(150, 60);
ctx.lineTo(250, 140);
ctx.closePath();
ctx.stroke();
      while (w < maxW) {
        const REPEAT_NUM = 3; //  取巧重复x方向
        const text = `潜水党专用    `; // 水印文本 空格用于x间隙
        const waterMarkText = text.repeat(REPEAT_NUM);
        ctx.translate(w, 200);
        ctx.globalAlpha = 0.3;
        ctx.fillStyle = '#fff';
        ctx.font = '32px Josefin Slab';
        ctx.rotate(-45 * Math.PI / 180);
        ctx.fillText(waterMarkText, 0, 0);
        ctx.rotate(45 * Math.PI / 180); // 画笔角度恢复
        w = w + 20;
      }
    }
  }
  var video = document.getElementById("video");
  var canvas = document.getElementById("canvas"),
  canvas2 = document.getElementById("canvas2"),
      context = canvas.getContext("2d"),
      context2 = canvas2.getContext("2d");
      waterMask(context2, 10, 100)
  var w;
  var host = 'localhost';
      var port = 8888;
      var url = 'ws://' + host + ':' + port + '/';
  if (navigator.webkitGetUserMedia) {
      navigator.webkitGetUserMedia({ video: {
        width: 800,
        height: 600
      } }, function (stream) {
        console.log('stream', stream)
          // 错误代码:
          // video.src = window.webkitURL.createObjectURL(stream); // 浏览器正在取消对 createObjectURL 的支持
          // 正确代码:
          video.srcObject = stream; 
          video.play();
          w = new WebSocket(url);
          w.onopen = function () {
              sendImg();
          }
          w.onmessage = function (e) {
              sendImg();
          }

      }, function () {
          console.log("video error");
      });
      function sendImg() {
        context.drawImage(video, 0, 0, 640, 640);
       
          var imgData = canvas.toDataURL();
          w.send(imgData);
      }
    }

    

main()
let count = 0
document.addEventListener('visibilitychange',function(){ //浏览器切换事件
    if(document.visibilityState=='hidden') { //状态判断
        //normal_title=document.title;
        count ++
    }else {
      if(count > 2) {
        return window.close()
      }
        if (count) alert('您已经离开' + count +'次当前页面，请避免相关行为')
        
    }
})
</script>
</html>